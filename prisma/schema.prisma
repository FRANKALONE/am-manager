generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Parameter {
  id       Int     @id @default(autoincrement())
  category String
  label    String
  value    String
  isActive Boolean @default(true)
  order    Int     @default(0)

  @@index([category])
}

model Client {
  id                 String              @unique
  name               String
  manager            String?
  amOnboardingDate   DateTime?
  customAttributes   String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  portalUrl          String?
  clientLogo         String?
  clientPortalUrl    String?
  jiraProjectKey     String?
  reportEmails       String?
  isDemo             Boolean             @default(false)
  evolutivoProposals EvolutivoProposal[]
  jiraCustomerUsers  JiraCustomerUser[]
  jiraOrganizations  JiraOrganization[]
  jiraUserRequests   JiraUserRequest[]
  users              User[]
  workPackages       WorkPackage[]
}

model WorkPackage {
  id                   String           @id
  name                 String
  clientId             String
  clientName           String
  contractType         String
  billingType          String
  renewalType          String
  accumulatedHours     Float            @default(0.0)
  accumulatedHoursDate DateTime?
  jiraProjectKeys      String?
  tempoAccountId       String?
  oldWpId              String?
  hasIaasService       Boolean          @default(false)
  lastSyncedAt         DateTime?
  customAttributes     String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  includeEvoEstimates  Boolean          @default(true)
  includeEvoTM         Boolean          @default(true)
  includedTicketTypes  String?
  isMainWP             Boolean          @default(false)
  renewalNotes         String?
  monthlyMetrics       MonthlyMetric[]
  regularizations      Regularization[]
  reviewRequests       ReviewRequest[]
  tickets              Ticket[]
  validityPeriods      ValidityPeriod[]
  wpCorrections        WPCorrection[]
  client               Client           @relation(fields: [clientId], references: [id])
  worklogDetails       WorklogDetail[]
}

model Regularization {
  id                    Int         @id @default(autoincrement())
  workPackageId         String
  date                  DateTime
  type                  String
  quantity              Float
  description           String?
  ticketId              String?
  note                  String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  reviewedForDuplicates Boolean     @default(false)
  isBilled              Boolean     @default(true)
  isRevenueRecognized   Boolean     @default(false)
  createdBy             String?
  createdByName         String?
  ticketType            String?
  workPackage           WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
}

model User {
  id                    String               @id @default(uuid())
  name                  String
  surname               String?
  email                 String               @unique
  password              String
  role                  String
  clientId              String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  workPackageIds        String?
  lastLoginAt           DateTime?
  resetToken            String?              @unique
  resetTokenExpiry      DateTime?
  locale                String               @default("es")
  timezone              String               @default("Europe/Madrid")
  dateFormat            String               @default("DD/MM/YYYY")
  mustChangePassword    Boolean              @default(false)
  linkedEvolUser        EVOLEvolutivoUser?
  linkedJiraCustomer    JiraCustomerUser?
  requestedJiraRequests JiraUserRequest[]    @relation("RequestedJiraRequests")
  reviewedJiraRequests  JiraUserRequest[]    @relation("ReviewedJiraRequests")
  landingViews          LandingView[]        @relation("LandingViews")
  createdMassEmails     MassEmail[]          @relation("MassEmailCreator")
  massEmailRecipients   MassEmailRecipient[] @relation("MassEmailRecipients")
  notifications         Notification[]
  requestedReviews      ReviewRequest[]      @relation("RequestedReviews")
  reviewedRequests      ReviewRequest[]      @relation("ReviewedRequests")
  createdLandings       TemporaryLanding[]   @relation("LandingCreator")
  client                Client?              @relation(fields: [clientId], references: [id])

  @@index([locale])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isPremium   Int      @default(0)
}

model ValidityPeriod {
  id                       Int                   @id @default(autoincrement())
  workPackageId            String
  startDate                DateTime
  endDate                  DateTime
  totalQuantity            Float                 @default(0)
  rate                     Float                 @default(0)
  isPremium                Boolean               @default(false)
  premiumPrice             Float?
  regularizationRate       Float?
  scopeUnit                String                @default("HORAS")
  regularizationType       String?
  surplusStrategy          String?
  rateEvolutivo            Float?
  billingType              String?
  specialRegularizationId  String?
  specialRegularization    SpecialRegularization? @relation(fields: [specialRegularizationId], references: [id])
  workPackage              WorkPackage           @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
}

model CorrectionModel {
  id            Int            @id @default(autoincrement())
  name          String
  code          String         @unique
  description   String?
  isDefault     Boolean        @default(false)
  config        String
  status        String         @default("active")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  wpCorrections WPCorrection[]
}

model WPCorrection {
  id                Int             @id @default(autoincrement())
  workPackageId     String
  correctionModelId Int
  startDate         DateTime
  endDate           DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  correctionModel   CorrectionModel @relation(fields: [correctionModelId], references: [id])
  workPackage       WorkPackage     @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
}

model MonthlyMetric {
  id            Int         @id @default(autoincrement())
  workPackageId String
  year          Int
  month         Int
  consumedHours Float       @default(0.0)
  reportSentAt  DateTime?
  reportSentBy  String?
  workPackage   WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@unique([workPackageId, year, month])
}

model WorklogDetail {
  id               Int         @id @default(autoincrement())
  workPackageId    String
  year             Int
  month            Int
  issueKey         String?
  issueType        String
  issueSummary     String
  timeSpentHours   Float
  startDate        DateTime
  author           String
  tipoImputacion   String?
  issueCreatedDate DateTime?
  originWpId       String?
  billingMode      String?
  workPackage      WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@index([workPackageId, year, month])
}

model Ticket {
  id                Int         @id @default(autoincrement())
  workPackageId     String
  issueKey          String
  issueSummary      String
  issueType         String
  createdDate       DateTime
  year              Int
  month             Int
  status            String
  reporter          String
  reporterEmail     String?
  billingMode       String?
  priority          String?
  slaResolution     String?
  slaResponse       String?
  slaResolutionTime String?
  slaResponseTime   String?
  assignee          String?
  dueDate           DateTime?
  parentKey         String?
  originalEstimate  Float?
  component         String?
  clientJiraId      String?
  resolution        String?
  proDeliveryDate   DateTime?   @db.Timestamptz(6)
  workPackage       WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@unique([workPackageId, issueKey])
  @@index([workPackageId, year, month])
  @@index([proDeliveryDate])
  @@index([clientJiraId])
}

model TicketStatusHistory {
  id             Int       @id @default(autoincrement())
  issueKey       String
  type           String
  status         String
  transitionDate DateTime  @db.Timestamptz(6)
  author         String?
  createdAt      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([issueKey, type])
  @@index([transitionDate])
}

model ReviewRequest {
  id              String      @id @default(cuid())
  workPackageId   String
  requestedBy     String
  worklogIds      String
  reason          String
  status          String
  reviewedBy      String?
  reviewNotes     String?
  approvedIds     String?
  createdAt       DateTime    @default(now())
  reviewedAt      DateTime?
  requestedByUser User        @relation("RequestedReviews", fields: [requestedBy], references: [id])
  reviewedByUser  User?       @relation("ReviewedRequests", fields: [reviewedBy], references: [id])
  workPackage     WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@index([workPackageId, status])
  @@index([requestedBy])
  @@index([status, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  relatedId String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model NotificationSetting {
  id           String   @id @default(cuid())
  type         String   @unique
  title        String
  description  String?
  isEnabled    Boolean  @default(true)
  roles        String   @default("ADMIN,GERENTE")
  group        String   @default("GENERAL")
  updatedAt    DateTime @updatedAt
  sendEmail    Boolean  @default(false)
  appMessage   String?
  emailSubject String?
  emailMessage String?
}

model ImportLog {
  id             Int      @id @default(autoincrement())
  date           DateTime @default(now())
  type           String
  status         String
  filename       String?
  totalRows      Int?
  processedCount Int?
  errors         String?
  delimiter      String?
  createdAt      DateTime @default(now())
}

model EvolutivoProposal {
  id                Int       @id @default(autoincrement())
  clientId          String
  issueKey          String    @unique
  issueSummary      String
  status            String
  createdDate       DateTime
  assignee          String?
  reporter          String?
  components        String?
  priority          String?
  relatedTickets    String?
  issueCreatedDate  DateTime?
  lastSyncedAt      DateTime  @default(now())
  resolution        String?
  sentToGerenteDate DateTime? @db.Timestamptz(6)
  sentToClientDate  DateTime? @db.Timestamptz(6)
  approvedDate      DateTime? @db.Timestamptz(6)
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model JiraOrganization {
  id         String             @id @default(cuid())
  jiraOrgId  String             @unique
  name       String
  clientId   String
  lastSyncAt DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  users      JiraCustomerUser[]
  client     Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([jiraOrgId])
}

model JiraCustomerUser {
  id             String           @id @default(cuid())
  accountId      String           @unique
  displayName    String
  emailAddress   String?
  active         Boolean          @default(true)
  accountType    String?
  organizationId String
  clientId       String
  linkedUserId   String?          @unique
  lastSyncAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  linkedUser     User?            @relation(fields: [linkedUserId], references: [id])
  organization   JiraOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([organizationId])
  @@index([emailAddress])
  @@index([accountId])
}

model JiraUserRequest {
  id              String    @id @default(cuid())
  clientId        String
  requestedBy     String
  type            String
  status          String
  email           String?
  displayName     String?
  jiraAccountId   String?
  reason          String?
  reviewNotes     String?
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  requestedByUser User      @relation("RequestedJiraRequests", fields: [requestedBy], references: [id])
  reviewedByUser  User?     @relation("ReviewedJiraRequests", fields: [reviewedBy], references: [id])

  @@index([clientId])
  @@index([status])
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  content   String?
  status    String
  error     String?
  messageId String?
  createdAt DateTime @default(now())

  @@index([to])
  @@index([createdAt])
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  group       String   @default("GENERAL")
  updatedAt   DateTime @updatedAt

  @@index([group])
}

model MassEmail {
  id            String               @id @default(cuid())
  createdAt     DateTime             @default(now())
  createdBy     String
  subject       String
  htmlBody      String
  targetRoles   String?
  targetClients String?
  targetWpTypes String?
  status        String               @default("DRAFT")
  scheduledFor  DateTime?
  sentAt        DateTime?
  attachments   String?
  creator       User                 @relation("MassEmailCreator", fields: [createdBy], references: [id])
  recipients    MassEmailRecipient[]
}

model MassEmailRecipient {
  id          String    @id @default(cuid())
  massEmailId String
  userId      String
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  massEmail   MassEmail @relation(fields: [massEmailId], references: [id], onDelete: Cascade)
  user        User      @relation("MassEmailRecipients", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([massEmailId, userId])
  @@index([massEmailId])
  @@index([userId])
}

model TemporaryLanding {
  id             String        @id @default(cuid())
  createdAt      DateTime      @default(now())
  createdBy      String
  slug           String        @unique
  title          String
  content        String
  allowedRoles   String
  allowedClients String?
  activeFrom     DateTime      @default(now())
  activeUntil    DateTime?
  isActive       Boolean       @default(true)
  showInHeader   Boolean       @default(false)
  priority       Int           @default(0)
  views          LandingView[]
  creator        User          @relation("LandingCreator", fields: [createdBy], references: [id])
}

model LandingView {
  id        String           @id @default(cuid())
  landingId String
  userId    String
  viewedAt  DateTime         @default(now())
  landing   TemporaryLanding @relation(fields: [landingId], references: [id], onDelete: Cascade)
  user      User             @relation("LandingViews", fields: [userId], references: [id], onDelete: Cascade)

  @@index([landingId])
  @@index([userId])
}

model Team {
  id        String       @id @default(cuid())
  jiraId    String?      @unique
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  members   TeamMember[]
}

model SpecialRegularization {
  id              String           @id @default(cuid())
  name            String           @unique
  type            String           // RAPPEL, CONSULTANT_LEVEL
  config          String           // JSON config
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  validityPeriods ValidityPeriod[]
}

model TeamMember {
  id             String               @id @default(cuid())
  name           String               @unique
  weeklyCapacity Float                @default(40.0)
  isActive       Boolean              @default(true)
  linkedUserId   String?              @unique
  level          String?              // Junior, Senior, etc.
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  teamId         String?
  assignments    CapacityAssignment[]
  team           Team?                @relation(fields: [teamId], references: [id])
}

model CapacityAssignment {
  id          String     @id @default(cuid())
  memberId    String
  description String?
  ticketKey   String?
  hours       Float
  startDate   DateTime
  endDate     DateTime
  status      String     @default("ACTIVE")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  member      TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([startDate, endDate])
}

model EVOLDailyMetric {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique
  count     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AMADailyWorkload {
  id               Int      @id @default(autoincrement())
  date             DateTime @unique
  incidenciasCount Int
  evolutivosCount  Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model EVOLEvolutivoUser {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  password           String
  name               String?
  role               String    @default("USER")
  avatar             String?
  jiraGestorName     String?
  mustChangePassword Boolean   @default(false)
  lastLogin          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  linkedUserId       String?   @unique
  linkedUser         User?     @relation(fields: [linkedUserId], references: [id])
}
