generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Parameter {
  id       Int     @id @default(autoincrement())
  category String
  label    String
  value    String
  isActive Boolean @default(true)
  order    Int     @default(0)

  @@index([category])
}

model Client {
  id               String        @unique
  name             String
  manager          String?
  amOnboardingDate DateTime?
  customAttributes String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  portalUrl        String?
  clientLogo       String?
  clientPortalUrl  String?
  jiraProjectKey   String?
  reportEmails     String?
  isDemo           Boolean       @default(false)
  users            User[]
  workPackages     WorkPackage[]
  evolutivoProposals EvolutivoProposal[]
  jiraOrganizations JiraOrganization[]
  jiraCustomerUsers JiraCustomerUser[]
  jiraUserRequests  JiraUserRequest[]
}

model WorkPackage {
  id                   String           @id
  name                 String
  clientId             String
  clientName           String
  contractType         String
  billingType          String
  renewalType          String
  accumulatedHours     Float            @default(0.0)
  accumulatedHoursDate DateTime?
  jiraProjectKeys      String?
  tempoAccountId       String?
  oldWpId              String?
  hasIaasService       Boolean          @default(false)
  includedTicketTypes  String?
  includeEvoEstimates  Boolean          @default(true)
  includeEvoTM         Boolean          @default(true)
  lastSyncedAt         DateTime?
  customAttributes     String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  isMainWP             Boolean          @default(false)
  monthlyMetrics       MonthlyMetric[]
  regularizations      Regularization[]
  reviewRequests       ReviewRequest[]
  tickets              Ticket[]
  validityPeriods      ValidityPeriod[]
  wpCorrections        WPCorrection[]
  client               Client           @relation(fields: [clientId], references: [id])
  worklogDetails       WorklogDetail[]
}

model Regularization {
  id                    Int         @id @default(autoincrement())
  workPackageId         String
  date                  DateTime
  type                  String
  quantity              Float
  description           String?
  ticketId              String?
  note                  String?
  ticketType            String?     // Ticket type for manual consumptions (Evolutivo, Correctivo, etc.)
  reviewedForDuplicates Boolean     @default(false)
  isRevenueRecognized   Boolean     @default(false)
  isBilled              Boolean     @default(true)
  createdBy             String?
  createdByName         String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  workPackage           WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
}

model User {
  id               String          @id @default(uuid())
  name             String
  surname          String?
  email            String          @unique
  password         String
  role             String
  clientId         String?
  locale           String          @default("es")
  timezone         String          @default("Europe/Madrid")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  workPackageIds   String?
  lastLoginAt      DateTime?
  resetToken       String?         @unique
  resetTokenExpiry DateTime?
  mustChangePassword Boolean       @default(false)
  notifications    Notification[]
  reviewedRequests ReviewRequest[] @relation("ReviewedRequests")
  requestedReviews ReviewRequest[] @relation("RequestedReviews")
  client           Client?         @relation(fields: [clientId], references: [id])
  linkedJiraCustomer JiraCustomerUser?
  requestedJiraRequests JiraUserRequest[] @relation("RequestedJiraRequests")
  reviewedJiraRequests  JiraUserRequest[] @relation("ReviewedJiraRequests")
  
  // Mass emails and landings
  createdMassEmails MassEmail[] @relation("MassEmailCreator")
  massEmailRecipients MassEmailRecipient[] @relation("MassEmailRecipients")
  createdLandings   TemporaryLanding[] @relation("LandingCreator")
  landingViews      LandingView[] @relation("LandingViews")

  // AMA Evolutivos Module
  linkedEvolUser    EVOLEvolutivoUser?

  @@index([locale])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions String
  isActive    Boolean  @default(true)
  isPremium   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ValidityPeriod {
  id                 Int         @id @default(autoincrement())
  workPackageId      String
  startDate          DateTime
  endDate            DateTime
  totalQuantity      Float       @default(0)
  rate               Float       @default(0)
  isPremium          Boolean     @default(false)
  premiumPrice       Float?
  regularizationRate Float?
  scopeUnit          String      @default("HORAS")
  regularizationType String?
  surplusStrategy    String?
  rateEvolutivo      Float?
  workPackage        WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
}

model CorrectionModel {
  id            Int            @id @default(autoincrement())
  name          String
  code          String         @unique
  description   String?
  isDefault     Boolean        @default(false)
  config        String
  status        String         @default("active")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  wpCorrections WPCorrection[]
}

model WPCorrection {
  id                Int             @id @default(autoincrement())
  workPackageId     String
  correctionModelId Int
  startDate         DateTime
  endDate           DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  correctionModel   CorrectionModel @relation(fields: [correctionModelId], references: [id])
  workPackage       WorkPackage     @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
}

model MonthlyMetric {
  id            Int         @id @default(autoincrement())
  workPackageId String
  year          Int
  month         Int
  consumedHours Float       @default(0.0)
  reportSentAt  DateTime?
  reportSentBy  String?
  workPackage   WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@unique([workPackageId, year, month])
}

model WorklogDetail {
  id               Int         @id @default(autoincrement())
  workPackageId    String
  year             Int
  month            Int
  issueKey         String?
  issueType        String
  issueSummary     String
  timeSpentHours   Float
  startDate        DateTime
  author           String
  tipoImputacion   String?
  originWpId       String?
  issueCreatedDate DateTime?
  billingMode      String?
  workPackage      WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@index([workPackageId, year, month])
}

model Ticket {
  id            Int         @id @default(autoincrement())
  workPackageId String
  issueKey      String
  issueSummary  String
  issueType     String
  createdDate   DateTime
  year          Int
  month         Int
  status        String
  reporter      String
  reporterEmail String?
  billingMode   String?
  priority      String?
  slaResponse       String?
  slaResolution     String?
  slaResponseTime   String?
  slaResolutionTime String?
  assignee          String?
  dueDate           DateTime?
  parentKey         String?
  originalEstimate  Float?
  component         String?
  clientJiraId      String?      // ID of ticket in client's own JIRA (for FAIN, MOLECOR, UAX)
  workPackage       WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@unique([workPackageId, issueKey])
  @@index([workPackageId, year, month])
}


model ReviewRequest {
  id              String      @id @default(cuid())
  workPackageId   String
  requestedBy     String
  worklogIds      String
  reason          String
  status          String
  reviewedBy      String?
  reviewNotes     String?
  approvedIds     String?     // JSON array of approved worklog IDs
  createdAt       DateTime    @default(now())
  reviewedAt      DateTime?
  reviewedByUser  User?       @relation("ReviewedRequests", fields: [reviewedBy], references: [id])
  requestedByUser User        @relation("RequestedReviews", fields: [requestedBy], references: [id])
  workPackage     WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  @@index([workPackageId, status])
  @@index([requestedBy])
  @@index([status, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  relatedId String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model NotificationSetting {
  id          String   @id @default(cuid())
  type        String   @unique
  title       String
  description String?
  isEnabled   Boolean  @default(true)
  sendEmail   Boolean  @default(false)
  roles       String   @default("ADMIN,GERENTE")
  group       String   @default("GENERAL")
  
  // Templates
  appMessage     String?  @db.Text
  emailSubject   String?  @db.Text
  emailMessage   String?  @db.Text
  
  updatedAt   DateTime @updatedAt
}

model ImportLog {
  id             Int      @id @default(autoincrement())
  date           DateTime @default(now())
  type           String   // 'BULK_DATA' or 'REGULARIZATIONS'
  status         String   // 'SUCCESS', 'PARTIAL', 'ERROR'
  filename       String?
  totalRows      Int?
  processedCount Int?
  errors         String?  // JSON stringified array of error messages
  delimiter      String?
  createdAt      DateTime @default(now())
}

model EvolutivoProposal {
  id               Int      @id @default(autoincrement())
  clientId         String
  issueKey         String   @unique
  issueSummary     String
  status           String
  createdDate      DateTime
  assignee         String?
  reporter         String?
  components       String?
  priority         String?
  resolution       String?
  relatedTickets   String?  // JSON stringified array of related tickets
  issueCreatedDate DateTime?
  lastSyncedAt     DateTime @default(now())
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model JiraOrganization {
  id              String   @id @default(cuid())
  jiraOrgId       String   @unique // ID de la organización en JIRA
  name            String
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  users           JiraCustomerUser[]
  
  lastSyncAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([clientId])
  @@index([jiraOrgId])
}

model JiraCustomerUser {
  id                String   @id @default(cuid())
  accountId         String   @unique // Account ID de JIRA
  displayName       String
  emailAddress      String?
  active            Boolean  @default(true)
  accountType       String?
  
  // Relación con organización
  organizationId    String
  organization      JiraOrganization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relación con cliente
  clientId          String
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Vinculación con usuario de la app (opcional)
  linkedUserId      String?  @unique
  linkedUser        User?    @relation(fields: [linkedUserId], references: [id], onDelete: SetNull)
  
  lastSyncAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([clientId])
  @@index([organizationId])
  @@index([emailAddress])
  @@index([accountId])
}

model JiraUserRequest {
  id              String      @id @default(cuid())
  clientId        String
  requestedBy     String
  type            String      // 'CREATE' or 'DELETE'
  status          String      // 'PENDING', 'APPROVED', 'REJECTED'
  
  // Data for creation or reference for deletion
  email           String?
  displayName     String?
  jiraAccountId   String?     // For DELETE requests
  
  reason          String?
  reviewNotes     String?
  
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  client          Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  requestedByUser User        @relation("RequestedJiraRequests", fields: [requestedBy], references: [id])
  reviewedByUser  User?       @relation("ReviewedJiraRequests", fields: [reviewedBy], references: [id])

  @@index([clientId])
  @@index([status])
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  content   String?  @db.Text
  status    String   // 'SUCCESS', 'FAILED'
  error     String?  @db.Text
  messageId String?
  createdAt DateTime @default(now())

  @@index([to])
  @@index([createdAt])
}

model SystemSetting {
  key         String   @id
  value       String   @db.Text
  description String?
  group       String   @default("GENERAL") // e.g., "EMAIL", "JIRA"
  updatedAt   DateTime @updatedAt

  @@index([group])
}

model MassEmail {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  createdBy     String
  creator       User     @relation("MassEmailCreator", fields: [createdBy], references: [id])
  
  subject       String
  htmlBody      String   @db.Text
  
  // Filters
  targetRoles   String?  // CSV: "ADMIN,GERENTE"
  targetClients String?  // CSV of client IDs
  targetWpTypes String?  // CSV: "BOLSA,BD,EVENTOS"
  
  status        String   @default("DRAFT") // DRAFT, SCHEDULED, SENT
  scheduledFor  DateTime?
  sentAt        DateTime?
  
  attachments   String?  @db.Text // JSON: [{ name, url, type, size }]
  recipients    MassEmailRecipient[]
}

model MassEmailRecipient {
  id          String   @id @default(cuid())
  massEmailId String
  massEmail   MassEmail @relation(fields: [massEmailId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation("MassEmailRecipients", fields: [userId], references: [id], onDelete: Cascade)
  
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  
  @@unique([massEmailId, userId])
  @@index([massEmailId])
  @@index([userId])
}

model TemporaryLanding {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  createdBy     String
  creator       User     @relation("LandingCreator", fields: [createdBy], references: [id])
  
  slug          String   @unique // URL: /landing/{slug}
  title         String
  content       String   @db.Text // HTML content
  
  // Access control
  allowedRoles  String   // CSV: "GERENTE,ADMIN"
  allowedClients String? // CSV of client IDs (optional, for client-specific)
  
  // Scheduling
  activeFrom    DateTime @default(now())
  activeUntil   DateTime?
  
  isActive      Boolean  @default(true)
  
  // Display options
  showInHeader  Boolean  @default(false) // Show link in main nav
  priority      Int      @default(0)     // Order in nav
  
  views         LandingView[]
}

model LandingView {
  id        String   @id @default(cuid())
  landingId String
  landing   TemporaryLanding @relation(fields: [landingId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation("LandingViews", fields: [userId], references: [id], onDelete: Cascade)
  
  viewedAt  DateTime @default(now())
  
  @@index([landingId])
  @@index([userId])
}

model Team {
  id        String       @id @default(cuid())
  jiraId    String?      @unique // Jira/Tempo Team ID
  name      String
  members   TeamMember[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model TeamMember {
  id             String               @id @default(cuid())
  name           String               @unique // Matches Jira Display Name
  weeklyCapacity Float                @default(40.0)
  isActive       Boolean              @default(true)
  teamId         String?
  team           Team?                @relation(fields: [teamId], references: [id])
  linkedUserId   String?              @unique
  assignments    CapacityAssignment[]
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

model CapacityAssignment {
  id          String     @id @default(cuid())
  memberId    String
  member      TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  description String?    // For non-ticket assignments (internal meetings, vacations, etc)
  ticketKey   String?    // Optional link to Jira ticket
  hours       Float
  startDate   DateTime
  endDate     DateTime
  status      String     @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([memberId])
  @@index([startDate, endDate])
}

// ============================================
// MÓDULO: Control AMA Evolutivos (Prefijo: EVOL)
// ============================================

model EVOLDailyMetric {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique
  count     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EVOLEvolutivoUser {
  id                 Int      @id @default(autoincrement())
  email              String   @unique
  password           String
  name               String?
  role               String   @default("USER") // "ADMIN" | "USER"
  avatar             String?
  jiraGestorName     String?
  mustChangePassword Boolean  @default(false)
  lastLogin          DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relación opcional con usuarios principales de Manager AM
  linkedUserId       String?  @unique
  linkedUser         User?    @relation(fields: [linkedUserId], references: [id], onDelete: SetNull)
}
